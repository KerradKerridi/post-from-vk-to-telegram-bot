![Python](https://img.shields.io/badge/python-3.8.10-blue)
![pyTelegramBotApi](https://img.shields.io/badge/pyTelegramBotApi-4.7.0-red)
![vk-api](https://img.shields.io/badge/vk_api-11.9.9-green)

# From vk to tg bot

## О проекте

Простая реализация бота который забирает посты из ВК и отправляет их в ТГ группу с предложенными новостями.\
В этом канале к каждому посту рендерятся две inline кнопки "Опубликовать" / "Удалить" которыми дополнительно можно модерировать контент.

>Важно!\
> Бот обрабатывает только посты содержащие текст ИЛИ текст + 1 фото. С несколькими фото не работает.\
> Это связано с тем, что [в тг InlineKeyboard не работает с типом MediaGroup](https://stackoverflow.com/questions/67340754/can-you-use-telegram-inline-keyboards-in-media-groups)\
> Это необходимо учитывать при публикации постов. Если попадет такой пост, бот упадет до следующего запуска и необходимо либо в ручную обновить ID последнего поста в файлу settings.ini или отредактировать пост чтобы в нем стало одно фото.\
> На сервере где работает бот, он запускается по крону каждые 5 мин.

## Схема работы

Бот сперва авторизуется в ВК -> Получает посты из необходимой группы(domain) -> Отправляет посты в ТГ канал с предложенными новостями (group_for_posts) -> После публикации отправляет посты в необходимый канал (channel)

## Что умеет
1. Ходит в ВК в определенную группу и получает посты со стены
2. Отправляет посты в группу ТГ с возможностью премодерации их в группе перед отправкой в канал
3. Отправляет посты в ТГ канал
4. Целевой пост в ВК будет выглядеть примерно так:

>Пост из ВК:\
Это тестовый пост от анонимного пользователя номер 1\
Пост опубликован анонимно

5. При наличии автора поста:

>Пост из ВК:\
Это тестовый пост номер 2\
Автор поста: Павел Дуров\
Ссылка: https://vk.com/id1

## Начало работы

1. Копируем репозиторий 
  ```bash
  git clone https://github.com/KerradKerridi/post-from-vk-to-telegram-bot.git
  ```
2. Получаем vk api key: https://vkhost.github.io/
3. Получаем tg api key у https://t.me/botfather
4. Устанавливаем зависимости `python -m pip install -r requirements.txt`
5. Копируем файл settings_example.ini в settings.ini
```bash
cp settings_example.ini settings.ini
```
6. Заполняем файл settings.ini

| Параметр в settings      |                     Что вставляем                      | За что отвечает                                                                                        |
|--------------------------|:------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------|
| settings.last_id         |                           0                            | Идентификатор последнего пересланного поста в группе ВК                                                |
| settings.include_link    |                         false                          | Признак включать ли ссылку на пост ВК. При true добавляет в конце поста ссылку на пост из ВК           |
| settings.preview_link    |                         false                          | Отключает предпросмотр ссылок при отправке в телеграм. Передается в параметр: disable_web_page_preview |
| settings.group_for_posts |             Идентификатор группы в ТГ №1*              | Идентификатор группы с предложенными новостями. Туда будут приходить посты из ВК                       |
| settings.important_logs  |             Идентификатор группы в ТГ №2*              | Группа для важных логов. Туда пишет если что-то сломалось                                              |
| settings.group_for_logs  |             Идентификатор группы в ТГ №3*              | Группа для остальных логов. Не помню для чего используется, но в целом можно объединить с группой №2   |
| VK.login                 |                       Логин ВК**                       | Логин ВК.                                                                                              |
| VK.password              |                      Пароль ВК**                       | Пароль ВК.                                                                                             |
| VK.domain                |                   Домен группы в вк.                   | Домен группы в ВК. Обычно после vk.com/                                                                |
| VK.count                 | Количество постов забираемых за раз. 20-30 достаточно. | Количество постов забираемых ботом из ВК за раз                                                        |
| VK.api_token             |                 VK API KEY из пункта 4                 | ВК апи ключ                                                                                            |
| Telegram.bot_token       |                 TG API KEY из пункта 5                 | ТГ апи ключ от бота                                                                                    |
| Telegram.channel         |                Целевой канал в телеграм                | Целевой канал в телеграмм куда посты попадают после одобрения в предложенных новостях                  |

*Идентификатор группы или канала это не ник. Получить именно идентификатор можно у: https://t.me/username_to_id_bot

**не уверен в корректности валидации через логин + пароль + апи кей, возможно это можно оптимизировать
7. Стартуем командой `python main.py run`